# bazi-h5

一个基于 Vue3 + Nuxt3 的八字排盘 H5 应用。

## 技术栈

- **构建工具**: pnpm
- **前端框架**: Vue3 + Nuxt3
- **样式方案**: UnoCSS
- **组件库**: Avola UI
- **状态管理**: Pinia
- **网络请求**: $fetch (Nuxt 内置)
- **后端**: Nuxt3 Server API
- **数据库**: Prisma + SQLite

## 功能

- [x] 用户输入生辰信息进行八字排盘
- [x] 展示八字、大运、流年、十神、藏干等信息
- [x] 结果页支持通过 ID 分享和回查
- [x] 移动端优先适配
- [x] 用户注册与登录
- [x] 保存用户排盘历史记录

## 开发日志

### 2025-08-19

- **修复**: 解决了个人中心页面卡在骨架屏无法加载用户数据的问题。
- **根因**: 由于上次修复调整了 `isLoggedIn` 的判断逻辑，导致全局中间件中 `fetchUser()` 的调用条件失效，用户信息无法被主动获取。
- **解决方案**: 修改了 `middleware/auth.global.ts`，确保在应用初始化时，只要用户处于登录状态但本地无用户信息，就主动调用 `fetchUser()` 来恢复用户信息。
- **修复 (深度)**: 解决了已登录用户在页面间跳转后，登录状态偶发性丢失导致被重定向到登录页的 bug。
- **根因**: Pinia store (`stores/auth.ts`) 中的 `isLoggedIn` 计算属性错误地同时依赖了持久化的 `token` 和非持久化的 `user` 对象。
- **解决方案**: 修改 `isLoggedIn` 的逻辑，使其仅依赖于 `useCookie` 持久化的 `token`，保证了登录状态的真正持久化。
- **修复**: 修复了从个人中心的排盘历史记录跳转到结果页时，因路由守卫拦截而提示“未登录”的 bug。
- **详情**: 在全局路由中间件 `middleware/auth.global.ts` 中增加了白名单机制，将首页 `/` 和结果页 `/result` 设置为公开访问路由。
