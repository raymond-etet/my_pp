# bazi-h5

一个基于 Vue3 + Nuxt3 的八字排盘 H5 应用。

## 技术栈

- **构建工具**: pnpm
- **前端框架**: Vue3 + Nuxt3
- **样式方案**: UnoCSS
- **组件库**: Vant UI + Avola UI
- **状态管理**: Pinia
- **网络请求**: $fetch (Nuxt 内置)
- **后端**: Nuxt3 Server API
- **数据库**: Prisma + SQLite

## 功能

- [x] 用户输入生辰信息进行八字排盘
- [x] 展示八字、大运、流年、十神、藏干等信息
- [x] 结果页支持通过 ID 分享和回查
- [x] 移动端优先适配
- [x] 用户注册与登录
- [x] 保存用户排盘历史记录

## 开发日志

### 2025-08-19

- **修复**: 解决了个人中心页面卡在骨架屏无法加载用户数据的问题。
- **根因**: 由于上次修复调整了 `isLoggedIn` 的判断逻辑，导致全局中间件中 `fetchUser()` 的调用条件失效，用户信息无法被主动获取。
- **解决方案**: 修改了 `middleware/auth.global.ts`，确保在应用初始化时，只要用户处于登录状态但本地无用户信息，就主动调用 `fetchUser()` 来恢复用户信息。
- **修复 (深度)**: 解决了已登录用户在页面间跳转后，登录状态偶发性丢失导致被重定向到登录页的 bug。
- **根因**: Pinia store (`stores/auth.ts`) 中的 `isLoggedIn` 计算属性错误地同时依赖了持久化的 `token` 和非持久化的 `user` 对象。
- **解决方案**: 修改 `isLoggedIn` 的逻辑，使其仅依赖于 `useCookie` 持久化的 `token`，保证了登录状态的真正持久化。
- **修复**: 修复了从个人中心的排盘历史记录跳转到结果页时，因路由守卫拦截而提示“未登录”的 bug。
- **详情**: 在全局路由中间件 `middleware/auth.global.ts` 中增加了白名单机制，将首页 `/` 和结果页 `/result` 设置为公开访问路由。

### 2025-08-19 (下午) - UI 优化与功能增强

- **新增**: 集成 Vant UI 组件库，优化移动端交互体验

  - 安装 `vant` 和 `@vant/nuxt` 依赖
  - 在 `nuxt.config.ts` 中配置 Vant 模块

- **重构**: 首页排盘输入界面全面升级

  - **时间选择器**: 使用 `VanDatetimePicker` 替换原生输入框，提供更直观的日期选择体验
  - **时辰选择**: 用 `VanPicker` 实现十二时辰选择，支持"未知时辰"选项
  - **农历支持**: 集成 `lunar-javascript` 库，支持农历/公历切换
  - **闰月处理**: 农历模式下增加闰月开关，正确处理闰月转换
  - **表单优化**: 使用 `VanRadioGroup`、`VanSwitch` 等组件提升交互体验

- **新增**: 农历转公历功能

  - 客户端使用 `lunar-javascript` 进行农历转公历计算
  - 支持闰月标识（用负数表示闰月）
  - 转换后统一提交公历日期给后端，确保后端逻辑统一

- **增强**: "我的排盘记录"页面显示优化

  - **四柱展示**: 每条历史记录右侧显示完整四柱（年、月、日、时）
  - **五行颜色**: 使用现有 `getWuxingColorStyle` 函数为干支应用五行颜色
  - **日主突出**: 日柱天干采用特殊样式（加粗+阴影）突出显示
  - **响应式布局**: 采用网格布局适配移动端显示

- **修复**: 历史记录 API 增强

  - 修改 `/api/pai-pan/history.get.ts`，返回完整排盘结果数据（`result` 字段）
  - 解决前端类型错误，使用类型断言处理 Prisma JSON 字段类型

- **技术栈更新**:
  - 新增依赖：`vant`、`@vant/nuxt`、`lunar-javascript`
  - 组件库：Vant UI (移动端) + Avola UI (部分场景)
